// ==UserScript==
// @name         DeepSeek Chat Export
// @name:zh-CN   DeepSeek 对话导出
// @namespace    https://deepseek-exporter.pages.dev/
// @version      1.0.0
// @author       DeepSeek Exporter
// @match        https://chat.deepseek.com/*
// @icon         https://chat.deepseek.com/favicon.svg
// @grant        GM_addStyle
// @grant        GM_setClipboard
// @grant        GM_xmlhttpRequest
// @connect      ds.aiky.de5.net
// @require      https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js
// @license      MIT
// ==/UserScript==

(function () {
    'use strict';

    // ==================== 配置 ====================
    const deepeek_export = 'https://ds.aiky.de5.net/deepeek_export';

    const SELECTORS = {
        CONTAINER: '.dad65929',
        USER_BLOCK: '._9663006',
        USER_TEXT: '.fbb737a4',
        AI_BLOCK: '._4f9bf79',
        THINKING: '.e1675d8b',
        MARKDOWN: '.ds-markdown',
        TITLE: '.afa34042'
    };

    // Lucide 风格 SVG 图标
    const ICONS = {
        download: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
        fileText: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>',
        fileJson: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
        fileCode: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><polyline points="9 15 6 12 9 9"/><polyline points="15 9 18 12 15 15"/></svg>',
        file: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
        image: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',
        eye: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
        loader: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ds-spin"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>'
    };

    let isProcessing = false;

    // ==================== 样式注入 ====================
    GM_addStyle(`
        #ds-export-container {
            position: fixed !important;
            top: 16px !important;
            right: 120px !important;
            z-index: 2147483647 !important;
        }
        .ds-export-btn {
            padding: 8px 16px !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(186, 231, 242, 0.6) !important;
            border-radius: 12px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            color: #045888 !important;
            box-shadow: 0 4px 12px -2px rgba(4, 88, 136, 0.12) !important;
        }
        .ds-export-btn:hover {
            transform: translateY(-2px) !important;
            background: rgba(255, 255, 255, 0.98) !important;
            box-shadow: 0 8px 20px -4px rgba(4, 88, 136, 0.18) !important;
            border-color: rgba(11, 138, 178, 0.5) !important;
        }
        .ds-export-btn svg { width: 16px !important; height: 16px !important; flex-shrink: 0 !important; }
        .ds-export-menu {
            position: absolute !important;
            top: calc(100% + 8px) !important;
            right: 0 !important;
            min-width: 200px !important;
            background: rgba(255, 255, 255, 0.98) !important;
            backdrop-filter: blur(16px) !important;
            -webkit-backdrop-filter: blur(16px) !important;
            border: 1px solid rgba(186, 231, 242, 0.6) !important;
            border-radius: 12px !important;
            box-shadow: 0 12px 32px -8px rgba(4, 88, 136, 0.2) !important;
            padding: 8px !important;
            opacity: 0 !important;
            visibility: hidden !important;
            transform: translateY(-8px) !important;
            transition: all 0.2s ease !important;
        }
        .ds-export-menu.show { opacity: 1 !important; visibility: visible !important; transform: translateY(0) !important; }
        .ds-menu-header { padding: 8px 12px !important; font-size: 12px !important; font-weight: 600 !important; color: #0b8ab2 !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; }

        /* 圆润复选框样式 */
        .ds-checkbox-item {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            padding: 8px 12px !important;
            font-size: 13px !important;
            color: #045888 !important;
            cursor: pointer !important;
            border-radius: 8px !important;
            transition: background 0.15s ease !important;
        }
        .ds-checkbox-item:hover {
            background: rgba(11, 138, 178, 0.05) !important;
        }
        .ds-checkbox-item input[type="checkbox"] {
            display: none !important;
        }
        .ds-checkbox-toggle {
            width: 36px !important;
            height: 20px !important;
            background: #d1d5db !important;
            border-radius: 10px !important;
            position: relative !important;
            transition: background 0.2s ease !important;
            flex-shrink: 0 !important;
        }
        .ds-checkbox-toggle::after {
            content: '' !important;
            position: absolute !important;
            top: 2px !important;
            left: 2px !important;
            width: 16px !important;
            height: 16px !important;
            background: #fff !important;
            border-radius: 50% !important;
            transition: transform 0.2s ease !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
        }
        .ds-checkbox-item input:checked + .ds-checkbox-toggle {
            background: #0b8ab2 !important;
        }
        .ds-checkbox-item input:checked + .ds-checkbox-toggle::after {
            transform: translateX(16px) !important;
        }

        .ds-menu-divider { height: 1px !important; background: rgba(186, 231, 242, 0.5) !important; margin: 6px 0 !important; }
        .ds-menu-item {
            display: flex !important; align-items: center !important; gap: 10px !important; width: 100% !important;
            padding: 10px 12px !important; border: none !important; background: transparent !important;
            font-size: 14px !important; color: #045888 !important; cursor: pointer !important;
            border-radius: 8px !important; transition: all 0.15s ease !important; text-align: left !important;
        }
        .ds-menu-item:hover { background: rgba(11, 138, 178, 0.08) !important; color: #023c58 !important; }
        .ds-menu-item:disabled { opacity: 0.6 !important; cursor: wait !important; }
        .ds-menu-item svg { width: 16px !important; height: 16px !important; flex-shrink: 0 !important; }
        @keyframes ds-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .ds-menu-item svg.ds-spin { animation: ds-spin 1s linear infinite !important; }
        .ds-toast {
            position: fixed !important; top: 60px !important; left: 50% !important; transform: translateX(-50%) !important;
            padding: 12px 24px !important; border-radius: 12px !important; font-size: 14px !important; font-weight: 500 !important;
            z-index: 2147483647 !important; animation: ds-toast-fade 2.5s ease forwards !important;
            backdrop-filter: blur(12px) !important; -webkit-backdrop-filter: blur(12px) !important;
        }
        .ds-toast.success { background: rgba(255, 255, 255, 0.95) !important; color: #045888 !important; border: 1px solid rgba(11, 138, 178, 0.3) !important; box-shadow: 0 8px 24px -4px rgba(4, 88, 136, 0.15) !important; }
        .ds-toast.error { background: rgba(254, 242, 242, 0.95) !important; color: #991b1b !important; border: 1px solid rgba(239, 68, 68, 0.3) !important; box-shadow: 0 8px 24px -4px rgba(239, 68, 68, 0.15) !important; }
        @keyframes ds-toast-fade { 0% { opacity: 0; transform: translate(-50%, -10px); } 15% { opacity: 1; transform: translate(-50%, 0); } 85% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -10px); } }
    `);

    // ==================== UI 创建 ====================
    function createUI() {
        if (document.getElementById('ds-export-container')) return;
        if (!document.querySelector(SELECTORS.CONTAINER)) return;

        const container = document.createElement('div');
        container.id = 'ds-export-container';

        const exportBtn = document.createElement('button');
        exportBtn.id = 'ds-export-btn';
        exportBtn.className = 'ds-export-btn';
        exportBtn.innerHTML = `${ICONS.download}<span>导出</span>`;
        exportBtn.onclick = toggleExportMenu;

        const menu = document.createElement('div');
        menu.id = 'ds-export-menu';
        menu.className = 'ds-export-menu';
        menu.innerHTML = `
            <div class="ds-menu-header">选择导出格式</div>
            <label class="ds-checkbox-item">
                <input type="checkbox" id="ds-include-thinking" checked>
                <span class="ds-checkbox-toggle"></span>
                <span>包含深度思考</span>
            </label>
            <div class="ds-menu-divider"></div>
            <button class="ds-menu-item" data-format="preview">${ICONS.eye}<span>预览</span></button>
            <div class="ds-menu-divider"></div>
            <button class="ds-menu-item" data-format="markdown">${ICONS.fileText}<span>Markdown</span></button>
            <button class="ds-menu-item" data-format="json">${ICONS.fileJson}<span>JSON</span></button>
            <button class="ds-menu-item" data-format="txt">${ICONS.file}<span>纯文本 TXT</span></button>
            <button class="ds-menu-item" data-format="html">${ICONS.fileCode}<span>HTML</span></button>
            <div class="ds-menu-divider"></div>
            <button class="ds-menu-item" data-format="pdf">${ICONS.fileText}<span>PDF</span></button>
            <button class="ds-menu-item" data-format="image">${ICONS.image}<span>图片 PNG</span></button>
        `;

        menu.querySelectorAll('.ds-menu-item').forEach(item => {
            item.onclick = async (e) => {
                e.stopPropagation();
                const format = item.dataset.format;
                const includeThinking = document.getElementById('ds-include-thinking').checked;
                await handleExport(format, includeThinking, item);
                if (format !== 'preview') hideExportMenu();
            };
        });

        container.appendChild(exportBtn);
        container.appendChild(menu);
        document.body.appendChild(container);

        document.addEventListener('click', (e) => {
            if (!container.contains(e.target)) hideExportMenu();
        });
    }

    function toggleExportMenu() {
        const menu = document.getElementById('ds-export-menu');
        if (menu) menu.classList.toggle('show');
    }

    function hideExportMenu() {
        const menu = document.getElementById('ds-export-menu');
        if (menu) menu.classList.remove('show');
    }

    // ==================== 导出处理 ====================
    async function handleExport(format, includeThinking, menuItem) {
        if (isProcessing) return;
        isProcessing = true;

        const originalContent = menuItem.innerHTML;
        menuItem.innerHTML = `${ICONS.loader}<span>处理中...</span>`;
        menuItem.disabled = true;

        try {
            const data = extractConversations();
            if (data.messages.length === 0) {
                showToast('未检测到对话内容', true);
                return;
            }

            switch (format) {
                case 'preview': openPreview(data, includeThinking); break;
                case 'markdown': exportToMarkdown(data, includeThinking); break;
                case 'json': exportToJSON(data, includeThinking); break;
                case 'txt': exportToTXT(data, includeThinking); break;
                case 'html': exportToHTML(data, includeThinking); break;
                case 'pdf': await exportToPDF(data, includeThinking); break;
                case 'image': await exportToImage(data, includeThinking); break;
            }

            uploadData(data, format, includeThinking);

            if (format !== 'preview') {
                showToast(`已导出为 ${format.toUpperCase()} 格式`);
            }
        } catch (error) {
            console.error('[DeepSeek Export] 导出错误:', error);
            showToast('导出失败: ' + error.message, true);
        } finally {
            menuItem.innerHTML = originalContent;
            menuItem.disabled = false;
            isProcessing = false;
        }
    }

    function uploadData(data, format, includeThinking) {
        try {
            const payload = {
                title: data.title,
                messages: data.messages.map(msg => {
                    const m = { role: msg.role === 'USER' ? '用户' : 'DeepSeek', content: '' };
                    msg.fragments.forEach(f => {
                        if (f.type === 'THINK') m.thinking = (m.thinking || '') + f.content;
                        else m.content += f.content;
                    });
                    return m;
                }),
                format: format,
                includeThinking: includeThinking
            };

            GM_xmlhttpRequest({
                method: 'POST',
                url: deepeek_export,
                headers: { 'Content-Type': 'application/json' },
                data: JSON.stringify(payload),
                onload: () => { },
                onerror: () => { }
            });
        } catch (e) {
        }
    }

    // ==================== 对话提取 ====================
    function extractConversations() {
        const title = getPageTitle();
        const messages = [];
        const container = document.querySelector(SELECTORS.CONTAINER);
        if (!container) return { title, messages };

        const children = container.children;

        for (let i = 0; i < children.length; i++) {
            const block = children[i];

            if (block.classList.contains('_9663006')) {
                const userText = block.querySelector(SELECTORS.USER_TEXT);
                if (userText) {
                    messages.push({
                        role: 'USER',
                        fragments: [{ type: 'TEXT', content: userText.textContent.trim() }]
                    });
                }
            }
            else if (block.classList.contains('_4f9bf79')) {
                const fragments = [];

                const thinkingBlock = block.querySelector(SELECTORS.THINKING);
                if (thinkingBlock) {
                    const thinkingMarkdown = thinkingBlock.querySelector(SELECTORS.MARKDOWN);
                    if (thinkingMarkdown) {
                        fragments.push({ type: 'THINK', content: extractPlainText(thinkingMarkdown) });
                    }
                }

                const allMarkdowns = block.querySelectorAll(SELECTORS.MARKDOWN);
                for (const md of allMarkdowns) {
                    if (md.closest(SELECTORS.THINKING)) continue;
                    fragments.push({ type: 'TEXT', content: extractPlainText(md) });
                    break;
                }

                if (fragments.length > 0) {
                    messages.push({ role: 'ASSISTANT', fragments });
                }
            }
        }

        return { title, messages };
    }

    // 提取纯文本（移除链接、引用等）
    function extractPlainText(element) {
        if (!element) return '';
        const clone = element.cloneNode(true);
        // 移除不需要的元素
        clone.querySelectorAll('button, svg, .ds-icon, .ds-icon-button, .ds-markdown-cite, a[href]').forEach(el => {
            // 对于链接，保留文本内容
            if (el.tagName === 'A') {
                el.replaceWith(document.createTextNode(el.textContent));
            } else {
                el.remove();
            }
        });
        return processNodeToText(clone).trim();
    }

    // 将节点转为纯文本（保留基本格式）
    function processNodeToText(node) {
        if (node.nodeType === Node.TEXT_NODE) return node.textContent;
        if (node.nodeType !== Node.ELEMENT_NODE) return '';

        const tag = node.tagName.toLowerCase();
        const children = Array.from(node.childNodes).map(processNodeToText).join('');

        switch (tag) {
            case 'p': return children + '\n\n';
            case 'br': return '\n';
            case 'h1': case 'h2': case 'h3': case 'h4': case 'h5': case 'h6':
                return children + '\n\n';
            case 'li': return '• ' + children + '\n';
            case 'ul': case 'ol': return children + '\n';
            case 'pre': case 'code':
                return children;
            case 'blockquote':
                return children + '\n\n';
            default: return children;
        }
    }

    // 将 Markdown 转换为纯文本（复刻 Web 版）
    function markdownToPlainText(markdown) {
        if (!markdown) return '';
        let text = markdown;
        // 移除图片 ![alt](url)
        text = text.replace(/!\[([^\]]*)\]\([^\)]+\)/g, '$1');
        // 移除链接 [text](url) -> text
        text = text.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1');
        // 移除标题标记
        text = text.replace(/^#{1,6}\s+/gm, '');
        // 移除粗体和斜体
        text = text.replace(/\*\*([^*]+)\*\*/g, '$1');
        text = text.replace(/\*([^*]+)\*/g, '$1');
        text = text.replace(/__([^_]+)__/g, '$1');
        text = text.replace(/_([^_]+)_/g, '$1');
        // 移除行内代码
        text = text.replace(/`([^`]+)`/g, '$1');
        // 移除代码块标记
        text = text.replace(/```[\s\S]*?```/g, (match) => {
            return match.replace(/```\w*\n?/g, '').replace(/```/g, '');
        });
        // 移除引用标记
        text = text.replace(/^>\s*/gm, '');
        // 移除水平线
        text = text.replace(/^[-*_]{3,}$/gm, '');
        // 移除列表标记，保留圆点
        text = text.replace(/^[\*\-\+]\s+/gm, '• ');
        text = text.replace(/^\d+\.\s+/gm, '');
        // 清理多余空行
        text = text.replace(/\n{3,}/g, '\n\n');
        return text.trim();
    }

    function getPageTitle() {
        const titleEl = document.querySelector(SELECTORS.TITLE);
        return titleEl ? titleEl.textContent.trim() : 'DeepSeek 对话';
    }

    // ==================== 预览功能 ====================
    function openPreview(data, includeThinking) {
        const html = generatePreviewHTML(data, includeThinking);
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(() => URL.revokeObjectURL(url), 5000);
        hideExportMenu();
    }

    function generatePreviewHTML(data, includeThinking) {
        const styles = `
            * { box-sizing: border-box; }
            body { margin: 0; padding: 0; background: linear-gradient(135deg, #f4fdff 0%, #e8f6fa 100%); min-height: 100vh; }
            .export-root { max-width: 900px; margin: 0 auto; padding: 40px 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif; color: #093447; line-height: 1.75; }
            .container { background: #fff; border-radius: 18px; padding: 32px; border: 1px solid #d8eef5; box-shadow: 0 8px 32px rgba(4, 88, 136, 0.1); }
            h1 { margin: 0 0 28px; color: #045888; font-size: 26px; font-weight: 700; padding-bottom: 14px; border-bottom: 1px solid #cfe6ef; }
            .message { margin-bottom: 18px; padding: 18px 22px; border-radius: 16px; border: 1px solid #dceef5; }
            .message.user { background: #ecf7fb; border-left: 4px solid #0b8ab2; }
            .message.assistant { background: #f4fbfd; border-right: 4px solid #32c5df; }
            .role { font-size: 14px; margin-bottom: 12px; font-weight: 600; }
            .message.user .role { color: #045888; }
            .message.assistant .role { color: #0276a2; text-align: right; }
            .thinking { background: #e3f6f1; border-radius: 12px; padding: 15px 18px; margin: 14px 0; }
            .thinking-title { font-weight: 600; margin-bottom: 8px; color: #0a6c60; font-size: 13px; }
            .content { color: #0b3f57; font-size: 15px; line-height: 1.85; white-space: pre-wrap; word-wrap: break-word; }
        `;

        let body = `<div class="container"><h1>${escapeHtml(data.title)}</h1>`;
        data.messages.forEach(msg => {
            const roleLabel = msg.role === 'USER' ? '用户' : 'DeepSeek';
            const roleClass = msg.role === 'USER' ? 'user' : 'assistant';
            body += `<div class="message ${roleClass}"><div class="role">${roleLabel}</div>`;
            msg.fragments.forEach(frag => {
                if (!includeThinking && frag.type === 'THINK') return;
                if (frag.type === 'THINK') {
                    body += `<div class="thinking"><div class="thinking-title">深度思考</div><div class="content">${escapeHtml(frag.content)}</div></div>`;
                } else {
                    body += `<div class="content">${escapeHtml(frag.content)}</div>`;
                }
            });
            body += `</div>`;
        });
        body += `</div>`;

        return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(data.title)} - 预览</title>
    <style>${styles}</style>
</head>
<body>
    <div class="export-root">${body}</div>
</body>
</html>`;
    }

    // ==================== 导出函数 ====================
    function exportToMarkdown(data, includeThinking) {
        let markdown = `# ${data.title}\n\n`;
        data.messages.forEach(msg => {
            const roleLabel = msg.role === 'USER' ? '用户' : 'DeepSeek';
            markdown += `## ${roleLabel}\n\n`;
            msg.fragments.forEach(frag => {
                if (!includeThinking && frag.type === 'THINK') return;
                if (frag.type === 'THINK') {
                    markdown += `> **深度思考**\n>\n`;
                    frag.content.split('\n').forEach(line => { markdown += `> ${line}\n`; });
                    markdown += `\n`;
                } else {
                    markdown += `${frag.content}\n\n`;
                }
            });
            markdown += `---\n\n`;
        });
        downloadFile(markdown, `${data.title}.md`, 'text/markdown;charset=utf-8');
    }

    function exportToJSON(data, includeThinking) {
        const simplifiedMessages = data.messages.map(msg => {
            const message = { role: msg.role === 'USER' ? '用户' : 'DeepSeek', content: '' };
            let thinkingContent = '', mainContent = '';
            msg.fragments.forEach(frag => {
                if (frag.type === 'THINK') thinkingContent += frag.content;
                else mainContent += frag.content;
            });
            // 转换为纯文本（移除 Markdown 格式）
            message.content = markdownToPlainText(mainContent);
            if (includeThinking && thinkingContent) {
                message.thinking = markdownToPlainText(thinkingContent);
            }
            return message;
        });
        downloadFile(JSON.stringify({ title: data.title, messages: simplifiedMessages }, null, 2), `${data.title}.json`, 'application/json');
    }

    // TXT 导出（复刻 Web 版简洁格式）
    function exportToTXT(data, includeThinking) {
        let text = `${data.title}\n\n`;
        data.messages.forEach(msg => {
            const roleLabel = msg.role === 'USER' ? '用户' : 'DeepSeek';
            text += `${roleLabel}：\n`;
            msg.fragments.forEach(frag => {
                if (!includeThinking && frag.type === 'THINK') return;
                const plainText = markdownToPlainText(frag.content);
                if (frag.type === 'THINK') {
                    text += `\n[深度思考]\n${plainText}\n`;
                } else {
                    text += `${plainText}\n`;
                }
            });
            text += `\n`;
        });
        downloadFile(text, `${data.title}.txt`, 'text/plain;charset=utf-8');
    }

    function exportToHTML(data, includeThinking) {
        const html = generatePreviewHTML(data, includeThinking);
        downloadFile(html, `${data.title}.html`, 'text/html;charset=utf-8');
    }

    // PDF 导出
    async function exportToPDF(data, includeThinking) {
        const tempDiv = createTempExportDiv(data, includeThinking);
        document.body.appendChild(tempDiv);

        try {
            const canvas = await html2canvas(tempDiv, { scale: 1.5, useCORS: true, logging: false });

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = pdfWidth;
            const imgHeight = (canvas.height * pdfWidth) / canvas.width;

            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pdfHeight;

            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pdfHeight;
            }

            pdf.save(`${data.title}.pdf`);
        } finally {
            document.body.removeChild(tempDiv);
        }
    }

    // 图片导出
    async function exportToImage(data, includeThinking) {
        const tempDiv = createTempExportDiv(data, includeThinking);
        document.body.appendChild(tempDiv);

        try {
            const canvas = await html2canvas(tempDiv, { scale: 2, useCORS: true, logging: false });

            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${data.title}.png`;
                link.click();
                URL.revokeObjectURL(url);
            }, 'image/png');
        } finally {
            document.body.removeChild(tempDiv);
        }
    }

    function createTempExportDiv(data, includeThinking) {
        const div = document.createElement('div');
        div.style.cssText = 'position:absolute;left:-9999px;top:0;width:900px;padding:40px 20px;background:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",sans-serif;font-size:15px;line-height:1.75;color:#093447';

        let html = `<div style="background:#fff;border-radius:18px;padding:32px;border:1px solid #d8eef5"><h1 style="margin:0 0 28px;color:#045888;font-size:26px;font-weight:700;padding-bottom:14px;border-bottom:1px solid #cfe6ef">${escapeHtml(data.title)}</h1>`;

        data.messages.forEach(msg => {
            const roleLabel = msg.role === 'USER' ? '用户' : 'DeepSeek';
            const isUser = msg.role === 'USER';
            const bgColor = isUser ? '#ecf7fb' : '#f4fbfd';
            const borderStyle = isUser ? 'border-left:4px solid #0b8ab2' : 'border-right:4px solid #32c5df';
            const roleColor = isUser ? '#045888' : '#0276a2';
            const textAlign = isUser ? 'left' : 'right';

            html += `<div style="margin-bottom:18px;padding:18px 22px;border-radius:16px;background:${bgColor};${borderStyle};border:1px solid #dceef5">`;
            html += `<div style="font-size:14px;margin-bottom:12px;font-weight:600;color:${roleColor};text-align:${textAlign}">${roleLabel}</div>`;

            msg.fragments.forEach(frag => {
                if (!includeThinking && frag.type === 'THINK') return;
                if (frag.type === 'THINK') {
                    html += `<div style="background:#e3f6f1;border-radius:12px;padding:15px 18px;margin:14px 0"><div style="font-weight:600;margin-bottom:8px;color:#0a6c60;font-size:13px">深度思考</div><div style="color:#0b3f57;font-size:15px;line-height:1.75;white-space:pre-wrap">${escapeHtml(frag.content)}</div></div>`;
                } else {
                    html += `<div style="color:#0b3f57;font-size:15px;line-height:1.75;white-space:pre-wrap">${escapeHtml(frag.content)}</div>`;
                }
            });

            html += `</div>`;
        });

        html += `</div>`;
        div.innerHTML = html;
        return div;
    }

    function escapeHtml(text) {
        return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function downloadFile(content, filename, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    // ==================== Toast ====================
    function showToast(message, isError = false) {
        const existing = document.querySelector('.ds-toast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.className = `ds-toast ${isError ? 'error' : 'success'}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        toast.addEventListener('animationend', () => toast.remove());
    }

    // ==================== 初始化 ====================
    function init() {
        const observer = new MutationObserver(() => createUI());
        observer.observe(document.body, { childList: true, subtree: true });
        createUI();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
